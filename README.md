# 神经科学分析方法
非快速眼动期睡眠（NREM）或者全麻期间，广泛的脑皮质出现慢波（SOs）以及纺锤波（spindles）
## 数据集


## 相关性分析

### 时频图 (Time Frequency)
* 时频分析方法提供了时间域与频率域的联合分布信息，清楚地描述了**信号频率随时间变化的关系**。
* Matlab中的FieldTrip工具箱进行时频分析。使用“多锥度”时频变换（Slepian tapers，低频范围：0.3~100Hz）估计谱功率。 这种方法在32Hz的频率上使用恒定数量的周期（因此，时间窗口的持续时间随着频率的增加而减少），以及在32Hz以上的锥度数量增加的固定时间窗口，在高频通过平滑获得更精确的功率估计。
```
idx = 2;                        % choose subject
load(data_MO_name_ana{idx});    % load raw SEEG data
data_ana = SEEG;                % init SEEG struct
channel_se = {Hippocampus_selected{idx};ob_selected{idx};fi_selected{idx}};              % choose electrode
channel_se_idx = zeros(3,1);
for i = 1:length(channel_se)
    channel_se_idx(i,1) = find(ismember(SEEG.label,channel_se{i}));
end
slide_winow = 5;
cfg = [];
cfg.length  = slide_window;
cfg.overlap = 2.5/slide_window;
data_segmented = ft_redefinetrial(cfg, SEEG);
cfg = [];
cfg.method     = 'mtmfft'
cfg.taper      = 'hanning'
cfg.foilim     = [0 30];
cfg.keeptrials = 'yes'
freq_segmented = ft_freqanalysis(cfg, data_segmented);
final_wave = freq_segmented.powspctrm;
temp2 =squeeze(final_wave(:,channel_se_idx(1),:));

close all;figure(),set(gcf,'position',[100 100 1200 200]);

[temp_a,b] = size(temp2)

imagesc(50:temp_a,freq_segmented.freq,log10(temp2(50:temp_a,:)'),[-4,4]);
axis xy
% axis off;
colormap jet;
saveas(gcf,[Fig2a_path,'/Fig2a_top_2.png']);

hold on;plot([50,temp_a],[10,10],'k--','LineWidth',1);
hold on;plot([50,temp_a],[16,16],'k--','LineWidth',1);
hold on;plot([50,temp_a],[1,1],'k--','LineWidth',1);
title('2 Hippocampus time frequency spectrum','FontName','Times New Roman', 'FontSize',14);
ylabel('Frequency');
saveas(gcf,[Fig2a_path,'/Fig2a_Hippocampus_2.png']);

temp_OB =squeeze(final_wave(:,channel_se_idx(2),:));
close all;figure(),
imagesc(50:temp_a,freq_segmented.freq,log10(temp_OB(50:temp_a,:)'),[-4,4]);
axis xy
set(gcf,'position',[100 100 1200 200]);
% axis off;
colormap jet;
hold on;plot([50,temp_a],[10,10],'k--','LineWidth',1);
hold on;plot([50,temp_a],[16,16],'k--','LineWidth',1);
hold on;plot([50,temp_a],[1,1],'k--','LineWidth',1);
title('2 OB time frequency spectrum','FontName','Times New Roman', 'FontSize',14);
saveas(gcf,[Fig2a_path,'\Fig2a_OB_2.png']);

temp_FI =squeeze(final_wave(:,channel_se_idx(3),:));
close all;figure(),
imagesc(50:temp_a,freq_segmented.freq,log10(temp_FI(50:temp_a,:)'),[-4,4]);
axis xy
set(gcf,'position',[100 100 1200 200]);
% axis off;
colormap jet;
hold on;plot([50,temp_a],[10,10],'k--','LineWidth',1);
hold on;plot([50,temp_a],[16,16],'k--','LineWidth',1);
hold on;plot([50,temp_a],[1,1],'k--','LineWidth',1);
title('2 FI time frequency spectrum','FontName','Times New Roman', 'FontSize',14);
saveas(gcf,[Fig2a_path,'/Fig2a_FI_2.png']);
```
### 功率谱密度 (Power Spectral Density)
* 在物理学中，信号通常是波的形式表示，例如电磁波、随机振动或者声波。当波的功率频谱密度乘以一个适当的系数后将得到**每单位频率波携带的功率**，这被称为信号的功率谱密度。功率谱密度是信号功率内容与频率的量度。通常用于表征宽带随机信号。功率谱密度的幅度通过用于数字化信号的频谱分辨率进行归一化。
### 互相关 (Cross Correlation)
* 两个函数互相关的含义是：对两个函数分别作复数共轭和反向平移并使其相乘的无穷积分，或者说：第一个函数依次作复共轭和平移后与第二个函数相乘的无穷积分。可以证明，两个定义完全等价(可以互相导出)。从物理上看，**互相关运算的结果反映了两个信号之间相似性的量度**。特别是对于实函数$f(x)$和$h(x)$而言，其相关运算相当于求两函数的曲线相对平移 1个参变量x后形成的重叠部分与横轴所围区域的面积

## 因果性分析

### 互相关时间滞后 (Cross Correlation Time Lags)
* 为了分析不同静态随机过程之间的相关性，互相关被用作时间滞后的函数，给定长度为$N$的实现$X$和$Y$，$ R_{XY}(h) = \frac{1}{N}\sum^{N - h}_{t = 1}(X - \bar{X})(Y - \bar{Y}) $
### 相位差 (Phase Difference)
* 为了分析和比较具有更宽带宽的非平稳信号的瞬时相位，应用了广义相位范式。纺锤波spindle（10~16Hz）和慢波SOs（0.3~1Hz）首先在相应带宽下通过加窗sinc FIR滤波器进行滤波，并应用希尔伯特变换重建解析信号表示。给定滤波后的实值信号$x_n∈R,n ∈[1,2,…,N]$，$ N $为分析时间序列中的样本个数, 其解析信号表示为, $ A(x_n)= x_n + iH(x_n)$，$i$是虚数单位，$H$是希尔伯特变换。复解析信号的角度作为瞬时相位。为避免高频干扰造成的复杂骑行周期，检测出负瞬时频率，并用保持形状的分段三次插值解释替代。
### 转移熵 (TE, Transfer Entropy)
* 根据维纳原理，与单纯依靠过去预测$X$的未来相比，如果信号$Y$改善了对信号$X$未来的预测，这就表明$Y$和$X$之间存在因果关系。通过结合非线性相互作用，转移熵是一种基于信息论重新表述维纳原理的无模型方法。具体来说，他是基于$X_past$计算$X_t$和$Y_past$的互信息，$T_{Y→X}=I(X_t;Y_{past}│X_{past} )=S(X_t│X_{past} )-S(X_t |Y_{past},X_{past})$， 其中$I$表示互信息，$S$表示香农熵。由于转移熵是基于联合概率密度计算的，因此将信号分成等仓并进行校正，以消除由于采样有限而产生的偏差。

### 相位幅值耦合分析 (PAC, Phase Amplitude Coupling)
* 相位振幅耦合是研究脑电和脑磁图中认知过程的一个很有前途的方法。相位振幅耦合是交叉频率耦合的一种重要形式，通常表示为低频振荡的相位调制高频振荡的振幅。我们在这里介绍**锁相值**、**平均向量长度**、**调制指数**以及**广义线性模型交叉频率耦合**四种方法，并对他们的使用场景进行了推荐。
* 脑电图数据的一个特征是其频谱与功率成正比，也就是说，频率f越高，振幅P(f)越弱。对数据的低频相位进行滤波，称为相位时间序列，对相同的数据的高频振幅进行滤波，称为振幅时间序列，具有较宽的带宽。高频振幅时间序列的准确带宽应取决于相位时间序列的频率。
* 利用MATLAB的信号处理工具箱，通过Hilbert变换提取相应的时间序列的相位和振幅。Hilbert变换操作是把信号的所有频率分量的相位推迟90度，利用希尔伯特变换从一个幅度、频率均被调制的调制波中把幅度、频率都解调了出来，相差90度的意义，就在于将实部与虚部实现了正交，变成了两个“基”。
* **计算相位幅值耦合**，首先对原始数据进行目标频带的带通滤波。其次，将带通滤波后的带通信号转换为复数解析信号。最后，从解析信号中提取相位或振幅。
```matlab
filtered_data = pop_eegfiltnew(raw_data,lower_frequency_bound,upper_frequency_bound);
analytic_signal = hilbert(filtered_data);
phase = phase(analytic_signal);
amplitude = abs(analytic_signal)
```
### 锁相值(PLV, Phase Locking Value)
* 对于PLV的计算，从低频滤波的解析信号中提取相位，从高频滤波的解析信号中提取幅值。然后振幅时间序列再次经过希尔伯特变换并从“第二次”解析信号中相位提取。通过这些步骤，可以得到每个数据点的两个时间序列的相位角。对于每个数据点，从相位时间序列的相位角中减去希尔伯特变换的振幅时间序列的相位角，得到相位角差。这些相位角差可以在极平面上以长度为1的向量表示，其中的角表示各自的相位角差。**两个时间序列之间的恒定相位滞后表明相幅耦合**。恒定的相位滞后导致极平面上的向量具有相似的方向。然后取所有向量的平均值：如果它们有恒定的相位滞后，它们指向相同的方向，导致一个相当长的平均向量。如果存在可变相位滞后，则向量分散在极面周围，导致较短的平均向量。平均向量的长度表示相幅耦合的量(耦合强度)。向量的方向表示两个时间序列之间的平均相位滞后，从相位滞后可以推断出首选耦合相位。
* **PLV的计算公式**，$PLV = \left |\frac{\sum^n_{t = 1}(e^{i(\theta_{lt} - \theta_{ut})})}{n} \right |$。其中$n$为数据点总数，$t$为一个数据点，$\theta_{lt}$为数据点$t$的低频相位角，$\theta_{ut}$为希尔伯特变换后的高频振幅时间序列的相位角。该指标的逻辑是：如果存在相位幅值耦合，高频时间序列的幅值将在低频处振荡。在这种情况下，从该信号中提取瞬时相位信息将给低频的瞬时相位信息返回某些恒定的相位滞后。否则，提取的是低频的瞬时相位存在不一致的相位滞时，则说明没有相位幅值耦合。
* 该方法的一个潜在缺点是，如果希尔伯特变换的振幅时间序列不以特定的频率振荡，将提取到无效的相位信息。在提取相位信息之前，可以通过对低频范围的希尔伯特变换的振幅时间序列进行滤波来抵消这一缺点。需要注意的是，目标的相位信息只能从窄带振荡中提取。希尔伯特变换的振幅时间序列不一定是这样的窄带振荡。
* **结果分析**：结果图中每条黑线表示两个信号在一个数据点的相位延迟。红色向量是所有黑色向量的平均值。上子图显示的是不一致、分散的相位滞后。分散的相位滞后导致相对较短的平均向量(红线)。下子图显示了一个相对恒定的相位滞后，在0°左右。相对恒定的相位滞后导致相对长的平均向量。
### 平均向量长度 (MVL, Mean Vector Length)
* 从低频滤波后的解析信号中提取相位，从高频滤波后的解析信号中提取幅值。MVL利用对应解析信号的每个复数(即每个数据点)的相位角和幅值，比较直接地估计耦合程度。解析时间序列的每个复值都是极平面上的一个向量。当所有向量的一部分的幅度M在一个特定的相位或在一个狭窄的相位范围内特别高时，就存在相位振幅耦合(上子图)。对所有向量取平均值将创建一个具有特定相位和长度的平均向量(图中的红色向量)。这个向量的长度表示相幅耦合的强度。方向代表振幅最强的平均相位。当不存在耦合时，所有向量相互抵消，平均向量将变短。那么它的方向不代表任何有意义的相位。
* **MVL的计算公式**，$MVL = \left |\frac{\sum^n_{t = 1}(a_{t}e^{i\theta_{t}})}{n} \right |$。其中$n$为数据点总数，
$t$ 为一个数据点，$a_t$为数据点$t$的振幅，$θ_t$为数据点$t$的相位角。MVL有三个需要注意的地方:(1)该值依赖于高频振幅的一般绝对振幅(独立于离群值)；(2)振幅异常值对MVL有较大的影响；(3)相位角往往不是均匀分布的，这些都可以被非参数置换检验抵消。Özkurt和Schnitzler提出了一种直接的MVL，它是幅值归一化的，范围在0到1之间。当对MVL和直接MVL应用置换检验时，返回的值基本上是相同的。也就是说，当与置换检验一起应用时，两种测量都是可互相替代的。在没有置换检验的情况下，建议使用直接MVL，因为它考虑了原始数据中可能的振幅差异。
* **结果分析**：图中每个黑点表示解析信号的一个数据点。在耦合的情况下，部分点(或向量)是特别长的(反映了强的振幅)。红色向量是所有黑色向量的平均值。它反映了耦合强度，即短为无耦合，长为耦合。
### 调制指数 (MI, Modulation Index)
* Tort等人提出了一种非常不同的计算相位幅值耦合的方法，但不管怎样，它都是基于相同参数的解析信号、幅值大小和相位角。根据Tort等人计算的MI，从−180°到180°所有可能的相位首先分箱（bin）为随意选择的数量。Tort等人使用18个bins，每个20度，之后很多研究人员也参考这个值，bins的数量会影响结果。低频相位的每个相位bin中，高频振幅的平均幅值计算并归一化：$ p(j) = \left |\frac{\bar{a}}{\sum^N_{k = 1}\bar{a}_k} \right |$。其中，$\bar{a}$为单个bin的平均振幅，$k$为bins的运行指数，$N$为bins的总数；$p$是维度为$N$的向量。计算得相位幅值图的数据，它以图形的方式描绘了实际的相位幅值耦合。随后计算香农熵，他是表示一个变量的固有信息量的一种度量。如果香农熵不是最大的，则该变量具有冗余性和可预测性。当每个相位bin的振幅相等，香农熵最大(均匀分布，上子图)。香农熵的计算公式如下: $H(p) = -\sum^N_{j = 1}p(j)\log(j)$。其中$p$是每个相位bin的归一化的平均振幅的向量，$N$是bins的总数。如果以后要应用置换检验，那么使用哪个对数基数并不重要。香农熵依赖于使用的bins的数量，这就是MI同样依赖于bins的数量的原因。Bins的数量越大，香农熵可以变得越大。相位振幅耦合的定义是一个明显偏离均匀分布的分布。Kullback-Leibler距离是两个分布的差别的度量，计算公式如下: $ KL(U, X) = \log{N} - H(p)$。其中$U$为均匀分布，$X$为数据分布，$N$为bins的总数，$H(p)$为前式得出的香农熵。均匀分布用$\log{N}$表示。最终的原始MI由以下公式计算: $ MI = \frac{KL(U, X)}{\log{N}}$
* **结果分析**：所有可能的相位从-180°到180°以20°为间距分箱为18个。每个条形反映了提供相位频率的特定相位对应的提供幅度的信号的平均振幅。此相位幅值图用香农熵进行量化。均匀分布的Shannon熵是最大的（上子图）。Kullback-Leibler距离度量给定的分布(下子图板中的分布)与均匀分布(上子图)的偏离程度。数据中相幅耦合越多，给定的相幅图偏离均匀分布越多，MI值越高。
### 广义线性模型交叉频率耦合 (GLM-CFC, generalized linear modeling cross-frequency coupling)
* 对于这个测量，使用数学函数，用一组预测变量(指的是低频相位)来预测一组响应变量(指的是高频振幅)。GLM扩展了线性回归模型，允许响应变量的非正态分布（例如伽马分布)和非线性连接函数(例如，对数连接函数)。因此，它们最适合于相位振幅耦合：相位和振幅确实呈现非线性关系，瞬时振幅值(从振幅包络线中提取)总是实数和正值，这在伽马分布(而不是正态分布)中得到最好的反映。
* 在计算GLM-CFC时，从低频滤波的解析信号中提取相位，从高频滤波的解析信号中提取幅值。然后可以在散点图中描绘相位和振幅值(上子图)。如果数据中存在相位幅值耦合，则在某一相位值时幅值特别高。如果没有相位幅值耦合，振幅值在所有可能的相位值上是相似的。事实上，GLM-CFC发现了两个模型之间的最大绝对差异，并将此差异计算为百分比变化。模型曲线非常类似于三阶多项式。然而，使用的不是多项式，而是放置在控制点之间的一组样条，它们在$-\pi$和$\pi$之间均匀间隔。这组样条更容易计算，而且它的特性可以比多项式更好的控制。另一方面，引入一种自由度(控制点的数量)，这可能会影响结果。因此Kramer和Eden纳入了Akaike信息标准(AIC)的评价，以确定最优控制点的数量。
* **结果分析**：散点图中的每个圆表示一个数据点。如果没有相位幅值耦合，振幅值在所有可能的相位值上是相似的。在这种情况下，水平线是数据最好的模型，而相位值没有预测能力。如果存在相位幅值耦合，在某些相位值时幅值特别高。在这种情况下，遵循振幅模式的曲线将最好地模拟数据。在相幅耦合的情况下，曲线(红线)与表示无耦合的水平线(黑线)不同。在没有相位振幅耦合的情况下，曲线与水平线表示没有耦合的模型几乎没有区别。

## 其他工具
### 皮尔逊相关 (product-moment coefficient of correlation)
* 积差相关是英国统计学家皮尔逊于20世纪初提出的一种计算相关的方法，因而被称为皮尔逊积差相关，简称皮尔逊相关。积差相关又称为积矩相关（product-moment coefficient of correlation)。通常，人们把离均差乘方之和除以N，用“积矩”概念表示。积差相关是一种运用较为普遍的计算相关系数的方法，也是揭示**两个变量线性相关方向和程度最常用和最基本的方法**。
### 置换检验 (Permutation Testing)
* 为了量化导出值的意义，所有方法需要经过置换检验。**通过重抽样得到统计量的复制，从而近似统计量的精确分布**。对于置换检验，将观察到的耦合值与洗牌耦合值的分布进行比较。通过计算原始相位时间序列和置换幅值时间序列(反之亦然)之间的耦合值来构造洗牌耦合值。随机在幅值时间序列某数据点上将数据分为两部分，并将两部分的顺序颠倒，构造出置换幅值时间序列。这种生成替代数据的方法是最保守的，因为它保留了脑电图数据的所有特征，除了所研究的相位角和幅值之间的时间关系。洗牌通常重复200-1000次(这里我们使用1000次结果更稳定)。将观察到的耦合值标准化为洗牌耦合值的分布，公式如下: $ CV_z = \frac{CV_{observaed} - \mu_{CV_{shuffled}}}{\sigma_{CV_{shuffled}}} $。其中$CV$为耦合值，$\mu$为平均值，$\sigma$为标准差$(SD)$。只有当观察到的$CV$大于95%的洗牌值(可以假设洗牌后的幅值时间序列和相位时间序列没有相关)时，才被定义为显著。








